---
title: "Import and Prep Data"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(magrittr)
library(envair)
```

```{r declareParameters}

# YEAR TO VALIDATE:
yearToValidate<-2023

parameters <- tolower(
  c(
    "CO",
    "H2S",
    "HF",
    "HUMIDITY",
    "NO",
    "NO2",
    "NOX",
    "O3",
    "PM10",
    "PM25",
    "SO2",
    "TEMP_MEAN",
    "TRS",
    "WDIR_VECT",
    "WSPD_SCLR"
  )
)

```

```{r importUnverifiedData}

data<-readr::read_rds("unverified_data.rds")

system.time({
data<-envair::importBC_data(
  parameter_or_station = parameters,
  years=yearToValidate,
  use_openairformat = FALSE
) %>%
  dplyr::distinct(.) %>%
  dplyr::filter(lubridate::year(DATE_PST) == yearToValidate)
})

readr::write_rds(data,"unverified_data.rds")

```

```{r validStatus}

# all data should have validation status 0. check this.
data %>%
  dplyr::distinct(year=lubridate::year(DATE_PST),
                  STATION_NAME_FULL,
                  PARAMETER,
                  VALIDATION_STATUS) %>% 
  dplyr::filter(VALIDATION_STATUS!="Level 0")

```

```{r NAstations}
#check if there are any stations with NA for STATION_NAME
data %>% 
  dplyr::filter(is.na(STATION_NAME))

# remove STATION_NAME that are NA's:

```

```{r duplicates}
# look for duplicates
duplicates<-data %>%
    dplyr::group_by(DATE_PST, 
                    STATION_NAME_FULL,
                    STATION_NAME,
                    PARAMETER, 
                    VALIDATION_STATUS,
                    INSTRUMENT) %>%
    dplyr::summarise(n = dplyr::n(), 
                     .groups = "drop") %>%
    dplyr::filter(n > 1L) %>%
   dplyr::left_join(.,
                    data,
                    by=c("DATE_PST",
                         "STATION_NAME_FULL",
                         "STATION_NAME",
                         "PARAMETER",
                         "VALIDATION_STATUS",
                         "INSTRUMENT"))%>%
              dplyr::arrange(DATE_PST,
                             STATION_NAME,
                             STATION_NAME_FULL,
                             PARAMETER) %>%
  dplyr::select(DATE_PST,
                STATION_NAME,
                STATION_NAME_FULL,
                PARAMETER,
                INSTRUMENT,
                RAW_VALUE,
                everything())

```

```{r oneoffs, eval=FALSE}
# Merritt Nicola Ave MAML has been updated (data was not padding and first started in feb), 
#so replace in data:
merrittMAML<-envair::importBC_data(parameter_or_station="Merritt Nicola Ave MAML",
                                   year=2022,
                                   use_openairformat = FALSE)

merrittMAML %<>% dplyr::filter(lubridate::year(DATE_PST)==2022)

merrittMAML %>%
  dplyr::filter(is.na(INSTRUMENT))

data %<>% 
  # remove previously imported merritt maml data for 2022
  dplyr::filter(!(STATION_NAME %in% "Merritt Nicola Ave MAML" & 
                    lubridate::year(DATE_PST)==2022)) %>%
  # bind updated merrit maml data
  dplyr::bind_rows(.,
                   merrittMAML)

# port edward sunset drive has some instrument == NA's (with all NA data)
#remove it

data %<>%
  dplyr::filter(!(STATION_NAME %in% "Port Edward Sunset Drive" & 
                    is.na(INSTRUMENT) &
                    lubridate::year(DATE_PST)==yearToValidate))

# Warfield Haley Park became operational on October 27 1600 (SO2) and on
# October 28 10:00 for all other parameters. Need to remove NA fields before (INSTRUMENT)
# and pad with NA's
warfieldHaley<-envair::importBC_data(parameter_or_station = "Warfield Haley Park",
                                     year=yearToValidate,
                                     use_openairformat = FALSE) %>%
  dplyr::filter(lubridate::year(DATE_PST)==yearToValidate)

data %<>%
  dplyr::filter(!(STATION_NAME=="Warfield Haley Park" & 
                    lubridate::year(DATE_PST)==yearToValidate)) %>%
  dplyr::bind_rows(.,
                   warfieldHaley)

#willow creek mine has NA's in the INSTRUMENT field when imported by parameter using envair, but not when imported by station. so - replace data imported by parameter (above for whole province) with data imported by station
willowCreekMine<-envair::importBC_data(parameter_or_station = "Willow Creek Mine",
                                       use_openairformat = FALSE,
                                       years = yearToValidate) %>%
  dplyr::filter(lubridate::year(DATE_PST)==yearToValidate)

data %<>%
  dplyr::filter(!(STATION_NAME=="Willow Creek Mine" & 
                    lubridate::year(DATE_PST)==yearToValidate)) %>%
  dplyr::bind_rows(.,
                   willowCreekMine)

#willow flats compressor station 2 has NA's in the INSTRUMENT field when imported by parameter using envair, but not when imported by station. so - replace data imported by parameter (above for whole province) with data imported by station
willowFlats<-envair::importBC_data(parameter_or_station = "Willow Flats Compressor Station 2",
                                       use_openairformat = FALSE,
                                       years = yearToValidate) %>%
  dplyr::filter(lubridate::year(DATE_PST)==yearToValidate)

data %<>%
  dplyr::filter(!(STATION_NAME=="Willow Flats Compressor Station 2" & 
                    lubridate::year(DATE_PST)==yearToValidate)) %>%
  dplyr::bind_rows(.,
                   willowFlats)

```


