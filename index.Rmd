---
title: "Annual Data Validation"
author: "Air Quality Section | Regional Operations Branch"
date: "`r format(Sys.time(), '%B %d, %Y')`"
params:
  preppedData: !r stringr::str_c("./preppedData/",dir('./preppedData')[20],collapse="")
  year: 2021
site: bookdown::bookdown_site
output: 
  bookdown::gitbook:
    config:
      toc:
        collapse: section
---

```{r setup,echo=FALSE,warning=FALSE,message=FALSE}
# To do's for next year:
# - add range slider to plotly so it's easy to pan along axes:
 #(https://plotly.com/r/range-slider/)
# - round aqs stats to match ecms
# - add difference row to sas summary

knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      echo = FALSE)

library(tidyverse)
library(openair)
library(Hmisc)
library(xts)
library(plotly)
library(RCurl)
library(DT)
library(feather)
library(magrittr)
library(readxl)
library(gdata)

# functions to calculate SAS stats from hourly data
source("./SAS_from_ftpData/pm25sasFcn.R")
source("./SAS_from_ftpData/pm10sasFcn.R")
source("./SAS_from_ftpData/no2sasFcn.R")
source("./SAS_from_ftpData/nosasFcn.R")
source("./SAS_from_ftpData/so2sasFcn.R")
source("./SAS_from_ftpData/o3sasFcn.R")
source("./SAS_from_ftpData/h2ssasFcn.R")
source("./SAS_from_ftpData/trssasFcn.R")
source("./SAS_from_ftpData/cosasFcn.R")

# path to ecms sas reports saved locally:
sasReports<-"C:/HagaR/AnnualDataValidation/SAS_reports"

source("plotlyFcn.R")
source("emptyPlot.R")

```

```{r importData}
data<-readRDS(params$preppedData)

# data<-readRDS("./preppedData/Grand Forks City Hall.rds")

prevYrWind<-data %>%
  dplyr::filter(lubridate::year(DATE_PST)==(params$year-1) &
                  PARAMETER %in% c("WSPD_SCLR","WDIR_VECT"))

data %<>%
  dplyr::filter(lubridate::year(DATE_PST)==params$year) %>%
  dplyr::group_by(PARAMETER) %>%
  dplyr::filter(!all(is.na(RAW_VALUE))) %>% dplyr::ungroup(.)
```


```{r dailyData}
day<-data %>%
    # rename to date for openair
    dplyr::rename(date=DATE_PST) %>%
    dplyr::group_by(STATION_NAME,PARAMETER,INSTRUMENT) %>%
    dplyr::group_modify(~ openair::timeAverage(.x,
                                               pollutant="RAW_VALUE",
                                               avg.time = "day",
                                               data.thresh = 75)
    ) %>%
    ungroup %>%
    dplyr::rename(DATE_PST=date)

`24hr`<-data %>%
    # rename to date for openair
    dplyr::rename(date=DATE_PST) %>%
    dplyr::group_by(STATION_NAME,PARAMETER,INSTRUMENT) %>%
    dplyr::group_modify(~ openair::rollingMean(.x,
                                               pollutant="RAW_VALUE",
                                               width = 24,
                                               align = "right",
                                               data.thresh = 75,
                                               new.name = "RAW_VALUE")
    ) %>%
    ungroup %>%
    dplyr::rename(DATE_PST=date)

```


```{r hourlyAndDaily}

# combine hourly and day data sets in one tidy tibble
allData<-data %>%
  dplyr::select(names(day)) %>%
  dplyr::mutate(TIME_AVG = "Hourly") %>%
  dplyr::bind_rows(.,
                   day %>%
                     dplyr::mutate(TIME_AVG = "Daily")) %>%
  dplyr::bind_rows(.,
                   `24hr` %>%
                     dplyr::mutate(TIME_AVG = "24-HR Running Ave"))


```


# Preamble {-}

**This report is for `r data %>% dplyr::pull(STATION_NAME) %>% unique %>% sort`**. 