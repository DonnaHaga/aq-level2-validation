---
title: "`r params$station` NO Statistical Summary"
author: Environmental and Climate Monitoring Section
output: html_document
params:
  station: !r as.character('Prince George')
  sas_file: !r as.character('')
---

```{r external setup, echo = FALSE,message= FALSE,warning=FALSE}
if (0)
{
  station <- 'Prince George Plaza 400'
  station <- 'Castlegar Zinio Park'
  parameter <- 'no'
  sas_summary <- 'A:/Air/Operations ORCS/Data/05_CAAQS/R Summaries/2019_UNSUPPRESSED/Submitted_200228/2019_NO_UNSUPPRESSED.xlsx'
  
}
station <- params$station
parameter <- 'NO'
sas_summary <- params$sas_file

```

## Background

This automated report provides statistical summaries of nitrogen monoxide (NO) at `r station` for the 2019 validation year. For details on the CAAQS criteria, Provincial Air Quality, and Pollution Control Objectives, [click on this link](https://www2.gov.bc.ca/assets/gov/environment/air-land-water/air/reports-pub/prov_aqo_fact_sheet.pdf). 
Please review this statistical summary and email any questions/response to _ECMS_.

```{r setup, echo=FALSE,message= FALSE,warning=FALSE,results = 'hide'}
setwd("A:/Air/Operations ORCS/Technology/Software Codes ScriptsExecutables/R_SCRIPTS/03_BCGovR/data_analysis_documents/Annual SAS Summaries")
library(tidyverse)
library(ggplot2)
library(ggforce)
library(lubridate)
library(gridExtra)
library(readxl)


list_stations <- listBC_stations() %>%
  select(STATION_NAME) %>%
  left_join(listBC_stations(2018)) %>%
  filter(tolower(STATION_NAME) == tolower(station)) %>%
  select(STATION_NAME,EMS_ID) %>%
  unique()

source('../../envair/R/importbc_data.R')
source('../../envair/R/envairfunctions.R')
source('../../envair/R/envairstatfunctions.R')
# datafile <- 'ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_Raw_Air_Data/CaptureStatistics/aq_stats_unformatted.csv'

```

__Table 1.__ Statistical Summary of NO at `r station`. Use vertical arrows next to column name to sort on that category. Use horizontal scrollbar to view more columns.
```{r official_stat,echo = FALSE, warning = FALSE, message = FALSE}

#header of the excel file, extracted separately
df_stat_header <- read_excel(sas_summary,n_max=2,col_names = FALSE) 
df_stat_header_trans  <- df_stat_header%>%
  data.table::transpose() %>%
  dplyr::mutate(V1 = gsub('HOURLY PERCENTILES','%(hr)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*DAILY 1-HR MAXIMUM.*$','%(D1HM)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*MONITORING MONTHS.*$','(days)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*QUARTERLY DATA.*$','(%days)',V1,ignore.case = TRUE))
  
#remove NA of column category values
repeat 
{
# df_nonNAs <- df_stat_header_trans[!is.na(df_stat_header_trans$V1),]
# df_NAs<- df_stat_header_trans[is.na(df_stat_header_trans$V1),] 

df_stat_header_trans <- df_stat_header_trans %>%
  dplyr::mutate(V1=ifelse(is.na(V1),lag(V1),V1))
  
if ((!any(is.na(df_stat_header_trans$V1)))){break}
}

df_stat_header_trans <- df_stat_header_trans %>%
  dplyr::mutate(columnname = ifelse(is.na(V2),
                                    V1,
                                    paste(V2,V1,sep=''))
                )

df_stat_official <- read_excel(sas_summary) %>%
  filter(tolower(station) == tolower(`STATION NAME`)) %>%
  arrange(`STATION NAME`,YEAR)


colnames(df_stat_official) <- df_stat_header_trans$columnname
df_stat_official <- df_stat_official %>%
  dplyr::mutate(
    `Q1(%days)` = as.integer(`Q1(%days)`),
    `Q2(%days)` = as.integer(`Q2(%days)`),
    `Q3(%days)` = as.integer(`Q3(%days)`),
    `Q4(%days)` = as.integer(`Q4(%days)`)
  )

DT::datatable(df_stat_official,options = list(
  scrollX = TRUE,
  scroller = TRUE,
  scrollY=300,
  searching = FALSE,
  paging = FALSE,
  pageLength =100))

```


## Percentiles of Hourly Values of NO

```{r Annual Percentiles, echo = FALSE,message= FALSE,warning=FALSE}


#add CAAAQS values based on hourly values
# df_stat_official <- df_stat_official %>% 
#   group_by(`STATION NAME`) %>%
#   arrange(`STATION NAME`,YEAR) %>%
#   dplyr::mutate(AVG_1=lag(`ANNUAL 1-HR AVG`,n=1),AVG_2 = lag(`ANNUAL 1-HR AVG`,n=2)) %>%
#   ungroup()%>%
#    group_by(`STATION NAME`, YEAR) %>%
#   dplyr::mutate(CAAQS_HR = mean(c(`ANNUAL 1-HR AVG`,AVG_1,AVG_2),na.rm = TRUE)) %>%
#   ungroup()
#  

#annual average values based on stats calculated
# p <- 
df_stat_official %>%
  dplyr::mutate(YEAR = as.factor(YEAR)) %>%
  dplyr::rename(`ANNUAL AVERAGE (1-hr),ppb`=`ANNUAL 1-HR AVG`) %>%
  ggplot(aes(x=YEAR)) +
  #geom_point(colour = 'blue',size=5) +
  geom_boxplot(aes(x=YEAR,lower=`25%(hr)`,middle=`50%(hr)`,upper=`75%(hr)`,
                   ymax=`75%(hr)` + 1.5* (`75%(hr)` - `25%(hr)`),
                   ymin=`0%(hr)`,
                   group = YEAR),stat='identity',colour = 'blue') +
  geom_point(aes(x=YEAR,y=`ANNUAL AVERAGE (1-hr),ppb`),colour='red',size=2) +
  #geom_point(aes(x=YEAR,y=CAAQS_HR),colour='red',size=4,shape=22) +
  geom_point(aes(x=YEAR,y=`100%(hr)`),shape=23) +
  #geom_hline(aes(yintercept = 17),colour='red',linetype = 'dashed') +
  facet_zoom(ylim=c(0,10)) +
  theme(axis.text.x =element_text(angle=45),axis.title.x=element_blank()) +
  ggtitle(label = paste(station,':NO',sep=''))+
    ylab('NO Hourly (1-hr) Concentration, ppb')

#print(p)  
#png(filename = lst_instruments$filename[lst_instruments$INSTRUMENT == instrument])
#  dev.off()




```

__Figure 1.__ Plot of _Hourly (1-hr) NO_ concentration at `r station`. Box plot represents 25th and 75th percentiles. Whiskers represent the minimum and the 1.5 x IQR values. Grey diamonds represent the maximum (100-percentile). Red dot represents the annual average. 

## Data Capture Summary

```{r datacapture, echo=FALSE, warning=FALSE,message = FALSE}

if (0)
{
  instrument <- 'PM25 SHARP5030'
}

#calculate the total hours, quarters, and days
df_dates <- df_stat_official %>%
  select(YEAR) %>%
   unique() %>%
  dplyr::mutate(start = ymd_hm(paste(YEAR,'-01-01 00:00',sep=''),tz='etc/gmt+8'),
         end=ymd_hm(paste(YEAR,'-12-31 23:00',sep=''),tz='etc/gmt+8')
)

 
  
seq_dates <- seq(min(df_dates$start),max(df_dates$end),by='hour')


df_totals <- tibble(
  DATE_PST = seq_dates,
  DATE_DAY =as.character(seq_dates,format='%Y-%m-%d'),
  YEAR = year(seq_dates),
  QUARTER = quarter(DATE_PST))%>%
  dplyr::mutate(DATE_PST = DATE_PST + 3600,
         QUARTER = paste('Q',QUARTER,sep='')) %>%
  group_by(YEAR) %>%
  dplyr::mutate(TOTAL_HOURS = n()) %>%
  ungroup() %>%
  select(-DATE_PST) %>%
  unique() %>%
  group_by(YEAR) %>%
  dplyr::mutate(TOTAL_DAYS = n()) %>%
  group_by(YEAR,QUARTER) %>%
  dplyr::mutate(TOTAL_QUARTER = n()) %>%
  select(-DATE_DAY) %>%
  unique()

df_stats_quarter <- df_stat_official %>%
  dplyr::rename(
    Q1=`Q1(%days)`,
    Q2=`Q2(%days)`,
    Q3=`Q3(%days)`,
    Q4=`Q4(%days)`
  ) %>%
  pivot_longer(cols =c(Q1,Q2,Q3,Q4),names_to = 'QUARTER',values_to = 'VALID_QUARTER') %>%
   dplyr::mutate(VALID_QUARTER = as.numeric(VALID_QUARTER)) %>%
  dplyr::mutate(VALID_QUARTER = ifelse(is.na(VALID_QUARTER),0,VALID_QUARTER)) %>%
  left_join(df_totals)
  
  #quarter data capture
 p1 <- df_stats_quarter %>%
    dplyr::mutate(YEAR = as.factor(YEAR)) %>%
    ggplot(aes(x=QUARTER,y=as.integer(VALID_QUARTER/TOTAL_QUARTER*100))) +
    geom_col(aes(fill = YEAR),position = position_dodge(),colour='black') +
    geom_hline(aes(yintercept = 60),colour='red') +
    #scale_fill_hue(l=40, c=35)+
    ylab('Percent of Days Captured (%)') +
    ggtitle(paste(station,':NO',sep='')) +
   theme(legend.position='none') +
  xlab('')
  
  #total hours and total days data capture
  p2 <-  df_stats_quarter %>%
     dplyr::mutate(YEAR = as.factor(YEAR),
           `Valid Hours (%)` = (`VALID HOURS`/TOTAL_HOURS) * 100,
           `Valid Days (%)` = (`VALID DAYS`/TOTAL_DAYS) *100) %>%
    unique() %>%
    pivot_longer(cols = c(`Valid Hours (%)`,`Valid Days (%)`)) %>%
    ggplot(aes(x=name,y=as.integer(value))) +
    geom_col(aes(fill = YEAR),colour='black',position = position_dodge()) +
    geom_hline(aes(yintercept = 75),colour='red') +
    #scale_fill_hue(l=40, c=35)+
    ylab('Percent Captured (%)') +
    theme(legend.position = 'bottom') +
    #ggtitle(station)+
   xlab('')
  
 grid.arrange(p1,p2,ncol=1)
 
  
  


```

__Figure 2.__ Valid data capture from the PM2.5 Analyzers at `r station`. Red horizontal line shows data capture requirements.
