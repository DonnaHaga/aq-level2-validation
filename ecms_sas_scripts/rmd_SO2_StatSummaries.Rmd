---
title:  "`r params$station` SO~2~ Statistical Summary"
author: Environmental and Climate Monitoring Section
output: html_document
params:
  station: !r as.character('Prince George')
  sas_file: !r as.character('')
---

```{r external setup, echo = FALSE}
if (0)
{
  station <- 'Prince George Plaza 400'
  station <- 'Castlegar Zinio Park'
  parameter <- 'SO2'
  sas_summary <- 'A:/Air/Operations ORCS/Data/05_CAAQS/R Summaries/2019_UNSUPPRESSED/Submitted_200228/2019_SO2_UNSUPPRESSED.xlsx'
  
  
}
station <- params$station
parameter <- 'so2'
sas_summary <- params$sas_file
# df_stats <- params$df_stats %>%
#     filter(grepl(station,STATION_NAME,ignore.case = TRUE),
#            grepl(parameter,PARAMETER,ignore.case = TRUE))



```

## Background

This automated report provides statistical summaries of SO~2~ at `r station` for the 2019 validation year. For details on the CAAQS criteria, and Provincial Air Quality Objectives, [click on this link](https://www2.gov.bc.ca/assets/gov/environment/air-land-water/air/reports-pub/prov_aqo_fact_sheet.pdf). 
Please review this statistical summary and email any questions/response to _ECMS_.

```{r setup, echo=FALSE,message= FALSE,warning=FALSE,results = 'hide'}
setwd("A:/Air/Operations ORCS/Technology/Software Codes ScriptsExecutables/R_SCRIPTS/03_BCGovR/data_analysis_documents/Annual SAS Summaries")
library(tidyverse)
library(ggplot2)
library(ggforce)
library(lubridate)
library(gridExtra)
library(readxl)

list_stations <- listBC_stations() %>%
  select(STATION_NAME) %>%
  left_join(listBC_stations(2018)) %>%
  filter(tolower(STATION_NAME) == tolower(station)) %>%
  select(STATION_NAME,EMS_ID) %>%
  unique()


source('../../envair/R/importbc_data.R')
source('../../envair/R/envairfunctions.R')
source('../../envair/R/envairstatfunctions.R')
#datafile <- 'ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_Raw_Air_Data/CaptureStatistics/aq_stats_unformatted.csv'

```


__Table 1.__ Statistical Summary of SO~2~ at `r station`. Use vertical arrows next to column name to sort on that category. Use horizontal scrollbar to view more columns. 
```{r official_stat,echo = FALSE, warning = FALSE, message = FALSE}

#header of the excel file, extracted separately
df_stat_header <- read_excel(sas_summary,n_max=2,col_names = FALSE) 
df_stat_header_trans  <- df_stat_header%>%
  data.table::transpose() %>%
  dplyr::mutate(V1 = gsub('HOURLY PERCENTILES','%(hr)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*DAILY 1-HR MAXIMUM.*$','%(D1HM)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*MONITORING MONTHS.*$','(days)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*QUARTERLY DATA.*$','(%days)',V1,ignore.case = TRUE))
  
#remove NA of column category values
repeat 
{
# df_nonNAs <- df_stat_header_trans[!is.na(df_stat_header_trans$V1),]
# df_NAs<- df_stat_header_trans[is.na(df_stat_header_trans$V1),] 

df_stat_header_trans <- df_stat_header_trans %>%
  dplyr::mutate(V1=ifelse(is.na(V1),lag(V1),V1))
  
if ((!any(is.na(df_stat_header_trans$V1)))){break}
}

df_stat_header_trans <- df_stat_header_trans %>%
  dplyr::mutate(columnname = ifelse(is.na(V2),
                                    V1,
                                    paste(V2,V1,sep=''))
                )

df_stat_official <- read_excel(sas_summary) %>%
  filter(tolower(station) == tolower(`STATION NAME`)) %>%
  arrange(`STATION NAME`,YEAR)


colnames(df_stat_official) <- df_stat_header_trans$columnname
df_stat_official <- df_stat_official %>%
  dplyr::mutate(
    `Q1(%days)` = as.integer(`Q1(%days)`),
    `Q2(%days)` = as.integer(`Q2(%days)`),
    `Q3(%days)` = as.integer(`Q3(%days)`),
    `Q4(%days)` = as.integer(`Q4(%days)`)
  )

DT::datatable(df_stat_official,options = list(
  scrollX = TRUE,
  scroller = TRUE,
  scrollY=300,
  searching = FALSE,
  paging = FALSE,
  pageLength =100))


```


## Percentiles of Hourly SO~2~ Values


Attainment of the 2020 CAAQS SO~2~ criteria based on the _annual average of 1-hr readings_ is  __5 ppb__.

```{r Annual Average, echo = FALSE, warning = FALSE, message = FALSE}

#annual average values based on hourly  values
  df_stat_official %>%
    dplyr::mutate(YEAR = as.factor(YEAR)) %>%
    ggplot(aes(x=YEAR)) +
    #geom_point(colour = 'blue',size=5) +
    geom_boxplot(aes(x=YEAR,lower=`25%(hr)`,middle=`50%(hr)`,upper=`75%(hr)`,
                     ymax=`75%(hr)` + 1.5 *(`75%(hr)` - `25%(hr)`),
                     ymin=`0%(hr)`,
                     group = YEAR),stat='identity',colour = 'blue') +
    geom_point(aes(x=YEAR,y=`ANNUAL 1-HR AVG`),colour='red',size=4) +
    geom_point(aes(x=YEAR,y=`100%(hr)`),shape=23) +
    #geom_point(aes(x=YEAR,y=`CAAQS_D8HM`),size=4,fill = 'red',shape=22) +
    geom_hline(aes(yintercept = 5),colour='red',linetype = 'dashed') +
    facet_zoom(ylim=c(0,10)) +
    theme(axis.text.x =element_text(angle=45),axis.title.x=element_blank()) +
    ggtitle(label = paste(station,':SO2',sep='')) +
    ylab('SO2 (1-Hr), ppb')
  

```

__Figure 1.__ Box plot of _annual 1-hr SO~2~_ readings at `r station`. Box plot represents 25th and 75th percentile of 1-hr readings. Whiskers represent the minimum and the maximum based on 1.5 x IQR values. Grey diamond is the maximum (100 percentile). Red dot represents annual average where CAAQS 2020 attainment criteria is _5 ppb_(red line).

## Percentiles of SO~2~ Daily 1-Hour Maximum

Attainment of the 2020 CAAQS criteria based on the _3-year averaged 99th percentile of the Daily 1-Hr Maximum_ is 70 ppb.

```{r Annual Percentiles, echo = FALSE, warning = FALSE, message = FALSE}

#add CAAAQS values based on daily 1-hour maximum values, 99% of daily
df_stat_official <- df_stat_official %>%
  group_by(`STATION NAME`) %>%
  arrange(`STATION NAME`,YEAR) %>%
  dplyr::mutate(`ANNUAL 99P_D1HM_1`=lag(`ANNUAL 99P_D1HM`,n=1),`ANNUAL 99P_D1HM_2` = lag(`ANNUAL 99P_D1HM`,n=2))%>%
  ungroup()%>%
  group_by(`STATION NAME`,YEAR) %>%
  dplyr::mutate(CAAQS_HR = mean(c(`ANNUAL 99P_D1HM`,`ANNUAL 99P_D1HM_1`,`ANNUAL 99P_D1HM_2`),na.rm = TRUE)) %>%
  ungroup()

#annual average values based on stats calculated

df_stat_official%>%
  
  dplyr::mutate(YEAR = as.factor(YEAR)) %>%
  
  ggplot(aes(x=YEAR)) +
  #geom_point(colour = 'blue',size=5) +
  geom_boxplot(aes(x=YEAR,lower=`25%(D1HM)`,middle=`50%(D1HM)`,upper=`75%(D1HM)`,
                   ymax=`75%(D1HM)` + 1.5 *(`75%(D1HM)` - `25%(D1HM)`),
                   ymin=`0%(D1HM)`,
                   group = YEAR),stat='identity',colour = 'blue') +
  geom_point(aes(x=YEAR,y=`ANNUAL 99P_D1HM`),colour='red',size=4,shape=22) +
  geom_point(aes(x=YEAR,y=CAAQS_HR),colour='red',size=2) +
  geom_point(aes(x=YEAR,y=`100%(D1HM)`),shape=23) +
  geom_hline(aes(yintercept = 70),colour='red',linetype = 'dashed') +
  facet_zoom(ylim=c(0,30)) +
  theme(axis.text.x =element_text(angle=45),axis.title.x=element_blank()) +
  ggtitle(label = paste(station,':SO2',sep='')) +
  ylab('SO2 Daily 1-Hr Maximum, ppb')


```

__Figure 2.__  Plot of _Annual Daily 1-hr Maximum_ SO~2~ concentration at `r station`. Box plot represents 25th and 75th percentiles. Whiskers represents the minimum and the 1.5 x IQR (Interquantile Range). Grey diamond represents the maximum (100 percentile). Red box represents the 99th percentile of the Daily 1-hr Maximum. 
Red dot represents 3-year average of the 99th percentile where the CAAQS criteria is _70 ppb_ (red).


## Data Capture Summary

```{r datacapture, echo=FALSE, warning=FALSE,message = FALSE, results = 'asis'}

if (0)
{
  instrument <- 'PM25 SHARP5030'
}

#calculate the total hours, quarters, and days
df_dates <- df_stat_official %>%
  select(YEAR) %>%
   unique() %>%
  dplyr::mutate(start = ymd_hm(paste(YEAR,'-01-01 00:00',sep=''),tz='etc/gmt+8'),
         end=ymd_hm(paste(YEAR,'-12-31 23:00',sep=''),tz='etc/gmt+8')
)

 
  
seq_dates <- seq(min(df_dates$start),max(df_dates$end),by='hour')


df_totals <- tibble(
  DATE_PST = seq_dates,
  DATE_DAY =as.character(seq_dates,format='%Y-%m-%d'),
  DATE_YEAR = year(seq_dates),
  QUARTER = quarter(DATE_PST))%>%
  dplyr::mutate(DATE_PST = DATE_PST + 3600,
         QUARTER = paste('Q',QUARTER,sep='')) %>%
  group_by(DATE_YEAR) %>%
  dplyr::mutate(TOTAL_HOURS = n()) %>%
  ungroup() %>%
  select(-DATE_PST) %>%
  unique() %>%
  group_by(DATE_YEAR) %>%
  dplyr::mutate(TOTAL_DAYS = n()) %>%
  group_by(DATE_YEAR,QUARTER) %>%
  dplyr::mutate(TOTAL_QUARTER = n()) %>%
  dplyr::select(-DATE_DAY) %>%
  ungroup()%>%
  select(-QUARTER,-TOTAL_QUARTER) %>%
  unique() %>%
  dplyr::rename(YEAR = DATE_YEAR)

df_stats_quarter <- df_stat_official %>%
  select(`STATION NAME`,YEAR,`Q1(%days)`,`Q2(%days)`,`Q3(%days)`,`Q4(%days)`,`VALID HOURS`,`VALID DAYS`) %>%
  dplyr::mutate(`Q1` = as.numeric(`Q1(%days)`),
                `Q2` = as.numeric(`Q2(%days)`),
                `Q3` = as.numeric(`Q3(%days)`),
                `Q4` = as.numeric(`Q4(%days)`),) %>%
  dplyr::mutate(`Q1` = ifelse(is.na(`Q1`),0,`Q1`),
                `Q2` = ifelse(is.na(`Q2`),0,`Q2`),
                `Q3` = ifelse(is.na(`Q3`),0,`Q3`),
                `Q4` = ifelse(is.na(`Q4`),0,`Q4`)) %>%
  dplyr::select(-c(`Q1(%days)`,`Q2(%days)`,`Q3(%days)`,`Q4(%days)`))%>%
  left_join(df_totals)
 
#Data capture for the quarters
  p1 <-df_stats_quarter %>%
    pivot_longer(cols = c(`Q1`,`Q2`,`Q3`,`Q4`)) %>%
    dplyr::rename(QUARTER = name) %>%
    dplyr::mutate(YEAR = as.factor(as.character(YEAR))) %>%
    ggplot(aes(x=QUARTER,y=value)) +
    geom_col(aes(fill = YEAR),position = position_dodge(),colour='black') +
    geom_hline(aes(yintercept = 60),colour='red') +
    #scale_fill_hue(l=40, c=35)+
    ylab('Percent of Days Captured (%)') +
    ggtitle(paste(station,':SO2')) +
   theme(legend.position='none') +
  xlab('')+
  theme(axis.text.x =element_text(angle=45),axis.title.x=element_blank())
  
  #total hours and total days data capture------
  p2 <- df_stats_quarter %>%
      dplyr::mutate(YEAR = as.factor(YEAR),
           `Valid Hours (%)` = (`VALID HOURS`/TOTAL_HOURS) * 100,
           `Valid Days (%)` = (`VALID DAYS`/TOTAL_DAYS) *100) %>%
    dplyr::select(`STATION NAME`,YEAR,`VALID HOURS`,`VALID DAYS`,TOTAL_HOURS,TOTAL_DAYS,
           `Valid Hours (%)`,`Valid Days (%)`) %>%
    unique() %>%
    pivot_longer(cols = c(`Valid Hours (%)`,`Valid Days (%)`)) %>%
    
    ggplot(aes(x=name,y=value)) +
    geom_col(aes(fill = YEAR),colour='black',position = position_dodge()) +
    geom_hline(aes(yintercept = 75),colour='red') +
    #scale_fill_hue(l=40, c=35)+
    ylab('Percent Captured (%)') +
    #ggtitle(station)+
   xlab('') +
    theme(legend.position = 'bottom')

 grid.arrange(p1,p2,ncol=1)
 
```

__Figure 3.__ Valid data capture from the 1-hr SO~2~ readings at `r station`. Red horizontal line shows the data capture criteria.
