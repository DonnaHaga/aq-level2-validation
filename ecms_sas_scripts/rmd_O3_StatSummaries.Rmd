---
title: "`r params$station` O~3~ Statistical Summary"
author: Environmental and Climate Monitoring Section
output: html_document
params:
  station: !r as.character('Prince George')
  sas_file: !r as.character('')
---

```{r external setup, echo = FALSE}
if (0)
{
  station <- 'Prince George Plaza 400'
  station <- 'Castlegar Zinio Park'
  parameter <- 'o3'
  sas_summary <- 'A:/Air/Operations ORCS/Data/05_CAAQS/R Summaries/2019_UNSUPPRESSED/Submitted_200228/2019_OZONE_UNSUPPRESSED.xlsx'

}
station <- params$station
parameter <- 'o3'
sas_summary <- params$sas_file




```

## Background

This automated report provides statistical summaries of O~3~ at `r station` for the 2019 validation year. For details on the CAAQS criteria, and Provincial Air Quality Objectives, [click on this link](https://www2.gov.bc.ca/assets/gov/environment/air-land-water/air/reports-pub/prov_aqo_fact_sheet.pdf). 
Please review this statistical summary and email any questions/response to _ECMS_.

```{r setup, echo=FALSE,message= FALSE,warning=FALSE,results = 'hide'}
setwd("A:/Air/Operations ORCS/Technology/Software Codes ScriptsExecutables/R_SCRIPTS/03_BCGovR/data_analysis_documents/Annual SAS Summaries")
library(tidyverse)
library(ggplot2)
library(ggforce)
library(lubridate)
library(gridExtra)
library(readxl)
source('../../envair/R/importbc_data.R')
source('../../envair/R/envairfunctions.R')
source('../../envair/R/envairstatfunctions.R')

list_stations <- listBC_stations() %>%
  select(STATION_NAME) %>%
  left_join(listBC_stations(2018)) %>%
  filter(tolower(STATION_NAME) == tolower(station)) %>%
  select(STATION_NAME,EMS_ID) %>%
  unique()
datafile <- 'ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_Raw_Air_Data/CaptureStatistics/aq_stats_unformatted.csv'

```



__Table 1.__ Statistical Summary of O~3~ at `r station`. Use vertical arrows next to column name to sort on that category. Use horizontal scrollbar to view more columns. 
```{r official_stat,echo = FALSE, warning = FALSE, message = FALSE}


#header of the excel file, extracted separately
df_stat_header <- read_excel(sas_summary,n_max=2,col_names = FALSE) 
df_stat_header_trans  <- df_stat_header%>%
  data.table::transpose() %>%
  dplyr::mutate(V1 = gsub('HOURLY PERCENTILES','%(hr)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*DAILY 8-HR ROLLING AVG.*$','%(D8HM)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*MONITORING MONTHS.*$','(days)',V1,ignore.case = TRUE)) %>%
  dplyr::mutate(V1 = gsub('^.*QUARTERLY DATA.*$','(%days)',V1,ignore.case = TRUE))
  
#remove NA of column category values
repeat 
{
# df_nonNAs <- df_stat_header_trans[!is.na(df_stat_header_trans$V1),]
# df_NAs<- df_stat_header_trans[is.na(df_stat_header_trans$V1),] 

df_stat_header_trans <- df_stat_header_trans %>%
  dplyr::mutate(V1=ifelse(is.na(V1),lag(V1),V1))
  
if ((!any(is.na(df_stat_header_trans$V1)))){break}
}

df_stat_header_trans <- df_stat_header_trans %>%
  dplyr::mutate(columnname = ifelse(is.na(V2),
                                    V1,
                                    paste(V2,V1,sep=''))
                )

df_stat_official <- read_excel(sas_summary) %>%
  filter(tolower(station) == tolower(`STATION NAME`)) %>%
  arrange(`STATION NAME`,YEAR)


colnames(df_stat_official) <- df_stat_header_trans$columnname

 df_stat_official <- df_stat_official %>%
   dplyr::mutate(
     `Q2 + Q3(%days)` = as.integer(`Q2 + Q3(%days)`)
   )
 

DT::datatable(df_stat_official,options = list(
  scrollX = TRUE,
  scroller = TRUE,
  scrollY=300,
  searching = FALSE,
  paging = FALSE,
  pageLength =100))


```


## Percentiles of Ozone Hourly (1-hr) Values

The former criteria based on 1-hr values (National Ambient Air Quality Objective) is 82 ppb.

```{r Annual Percentiles, echo=FALSE,message= FALSE,warning=FALSE,}


# #add CAAAQS values based on daily 1-hour maximum values, 98% of daily
# df_stat_official <- df_stat_official %>%
#   group_by(`STATION NAME`) %>%
#   arrange(`STATION NAME`,YEAR) %>%
#   dplyr::mutate(`ANNUAL 4_D8HM_1` = lag(`ANNUAL 4TH HIGHEST D8HM`,n=1),
#                 `ANNUAL 4_D8HM_2` = lag(`ANNUAL 4TH HIGHEST D8HM`,n=2)
#                 ) %>%
#   ungroup()%>%
#   group_by(`STATION NAME`,YEAR) %>%
#   dplyr::mutate(CAAQS_D8HM = mean(c(`ANNUAL 4TH HIGHEST D8HM`,
#                                   `ANNUAL 4_D8HM_1`,
#                                   `ANNUAL 4_D8HM_2`),
#                                 na.rm = TRUE)) %>%
#   ungroup()

#annual average values based on stats calculated

df_stat_official%>%
  
  dplyr::mutate(YEAR = as.factor(YEAR)) %>%
  
  ggplot(aes(x=YEAR)) +
  #geom_point(colour = 'blue',size=5) +
  geom_boxplot(aes(x=YEAR,lower=`25%(hr)`,middle=`50%(hr)`,upper=`75%(hr)`,
                   ymax=`100%(hr)`,
                   ymin=`0%(hr)`,
                   group = YEAR),stat='identity',colour = 'blue') +
  geom_point(aes(x=YEAR,y=`ANNUAL 1-HR AVG`),colour='red',size=2) +
  #geom_point(aes(x=YEAR,y=CAAQS_HR),colour='red',size=4,shape=22) +
  #geom_point(aes(x=YEAR,y=`100%`),shape=23) +
  geom_hline(aes(yintercept = 82),colour='red',linetype = 'dashed') +
  #facet_zoom(ylim=c(0,30)) +
  theme(axis.text.x =element_text(angle=45),axis.title.x=element_blank()) +
  ggtitle(label = paste(station,':Ozone',sep=''))+
  ylab('Ozone (1-hr), ppb')



```

__Figure 1.__ Box Plot of _Hourly (1-hr) O~3~_ at `r station`. Box plot represents 25th and 75th percentiles of 1-hr readings. Whiskers represent the minimum and the maximum values. Red dot represents the annual average. Red line represents the former 1-hr standard (82 ppb).

## Percentiles of Daily 8-Hr Maximum Values

CAAQS O~3~ criteria is based on the 3-year average _of the 4th Highest Daily 8-hr Maximum_. Criteria for attainment is _63 ppb_.

```{r Daily Percentiles, echo=FALSE,message= FALSE,warning=FALSE,}

#list the instruments
# lst_instruments <- df_stats %>%
#    filter(tolower(PARAMETER) == tolower(parameter),DATE_YEAR <2020, 
#           tolower(STATION_NAME) == tolower(station) ) %>%
#   select(STATION_NAME,PARAMETER,INSTRUMENT) %>%
#   unique() %>%
#   dplyr::mutate(index =1:n()) %>%
#   dplyr::mutate(filename = paste(station,INSTRUMENT,'PM25_Daily_',index,'.png',sep=''))

#add CAAAQS values based on 4th highest daily 8-hr maximums
df_stat_official <- df_stat_official %>%
  group_by(`STATION NAME`) %>%
  arrange(`STATION NAME`,YEAR) %>%
  dplyr::mutate(`ANNUAL 4TH HIGHEST D8HM_1`=lag(`ANNUAL 4TH HIGHEST D8HM`,n=1),`ANNUAL 4TH HIGHEST D8HM_2` = lag(`ANNUAL 4TH HIGHEST D8HM`,n=2)) %>%
  ungroup()%>%
  group_by(`STATION NAME`,YEAR) %>%
  dplyr::mutate(CAAQS_D8HM = mean(c(`ANNUAL 4TH HIGHEST D8HM`,`ANNUAL 4TH HIGHEST D8HM_1`,`ANNUAL 4TH HIGHEST D8HM_2`),na.rm = TRUE)) %>%
  ungroup()


#annual average values based on stats calculated
  df_stat_official %>%
    dplyr::mutate(YEAR = as.factor(YEAR)) %>%
    ggplot(aes(x=YEAR)) +
    #geom_point(colour = 'blue',size=5) +
    geom_boxplot(aes(x=YEAR,lower=`25%(D8HM)`,middle=`50%(D8HM)`,upper=`75%(D8HM)`,
                     ymax=`100%(D8HM)`,
                     ymin=`0%(D8HM)`,
                     group = YEAR),stat='identity',colour = 'blue') +
    geom_point(aes(x=YEAR,y=`ANNUAL 4TH HIGHEST D8HM`),colour='red',size=4,shape=22) +
    # geom_point(aes(x=YEAR,y=`100%(D1HM)`),shape=23) +
    geom_point(aes(x=YEAR,y=`CAAQS_D8HM`),size=2,colour = 'red') +
    geom_hline(aes(yintercept = 63),colour='red',linetype = 'dashed') +
    #facet_zoom(ylim=c(0,100)) +
    theme(axis.text.x =element_text(angle=45),axis.title.x=element_blank()) +
    ggtitle(label = paste(station,':Ozone',sep='')) +
    ylab('Ozone Daily 8-Hr Maximum, ppb')
  

#png(filename = lst_instruments$filename[lst_instruments$INSTRUMENT == instrument])
#  dev.off()




```

__Figure 2.__ Plot of _Daily 8-Hr Maximum Concentration_ of Ozone at `r station`. Box plot represents 25th and 75th percentiles. Whiskers represent the minimum and the maximum. Red box represents the 4th Highest Daily-8hr Maximum. Red dot represents the 3-yr average of the 4th Highest Daily-8hr Maximum where CAAQS criteria is _63 ppb_(red line).

## Data Capture Summary

```{r datacapture, echo=FALSE, warning=FALSE,message = FALSE}

if (0)
{
  instrument <- 'PM25 SHARP5030'
}

#calculate the total hours, quarters, and days
df_dates <- df_stat_official %>%
  select(YEAR) %>%
   unique() %>%
  dplyr::mutate(start = ymd_hm(paste(YEAR,'-01-01 00:00',sep=''),tz='etc/gmt+8'),
         end=ymd_hm(paste(YEAR,'-12-31 23:00',sep=''),tz='etc/gmt+8')
)

 
  
seq_dates <- seq(min(df_dates$start),max(df_dates$end),by='hour')


df_totals <- tibble(
  DATE_PST = seq_dates,
  DATE_DAY =as.character(seq_dates,format='%Y-%m-%d'),
  DATE_YEAR = year(seq_dates),
  QUARTER = quarter(DATE_PST))%>%
  dplyr::mutate(DATE_PST = DATE_PST + 3600,
         QUARTER = paste('Q',QUARTER,sep='')) %>%
  group_by(DATE_YEAR) %>%
  dplyr::mutate(TOTAL_HOURS = n()) %>%
  ungroup() %>%
  select(-DATE_PST) %>%
  unique() %>%
  group_by(DATE_YEAR) %>%
  dplyr::mutate(TOTAL_DAYS = n()) %>%
  group_by(DATE_YEAR,QUARTER) %>%
  dplyr::mutate(TOTAL_QUARTER = n()) %>%
  dplyr::select(-DATE_DAY) %>%
  ungroup()%>%
  select(-QUARTER,-TOTAL_QUARTER) %>%
  unique() %>%
  dplyr::rename(YEAR = DATE_YEAR)

df_stats_quarter <- df_stat_official %>%
  select(`STATION NAME`,YEAR,`Q2 + Q3(%days)`,`VALID HOURS`,`VALID DAYS`) %>%
  dplyr::mutate(`Q2 + Q3(%days)` = ifelse(is.na(`Q2 + Q3(%days)`),0,`Q2 + Q3(%days)`)) %>%
  left_join(df_totals)
 
#------
  df_stats_quarter %>%
    dplyr::mutate(YEAR = as.factor(as.character(YEAR))) %>%
    ggplot(aes(x=YEAR,y=as.integer(`Q2 + Q3(%days)`))) +
    geom_col(aes(fill = YEAR),position = position_dodge(),colour='black') +
    geom_hline(aes(yintercept = 75),colour='red') +
    #scale_fill_hue(l=40, c=35)+
    ylab('Percent of Q2+Q3 Days Captured (%)') +
    ggtitle(paste(station,':Ozone',sep='')) +
   theme(legend.position='none') +
  xlab('')+
  theme(axis.text.x =element_text(angle=45),axis.title.x=element_blank())
  
```

_Figure 3._ Valid data capture of the ozone analyzer at `r station`. Red horizontal line shows Q2 + Q3 data capture requirements (75%).
